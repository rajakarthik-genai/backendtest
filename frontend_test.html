<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MediTwin Complete API Test</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f7fa;
            line-height: 1.6;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }
        input[type="text"], input[type="email"], input[type="password"], 
        input[type="file"], textarea, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #007bff;
        }
        button {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,123,255,0.3);
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .success {
            color: #155724;
            background-color: #d4edda;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #c3e6cb;
            margin: 10px 0;
        }
        .error {
            color: #721c24;
            background-color: #f8d7da;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #f5c6cb;
            margin: 10px 0;
        }
        .info {
            color: #0c5460;
            background-color: #d1ecf1;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #bee5eb;
            margin: 10px 0;
        }
        .warning {
            color: #856404;
            background-color: #fff3cd;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #ffeaa7;
            margin: 10px 0;
        }
        .tokens-display {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin-top: 10px;
            word-break: break-all;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            border: 1px solid #dee2e6;
        }
        .hidden {
            display: none;
        }
        .tab-buttons {
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }
        .tab-button {
            background-color: #e9ecef;
            color: #495057;
            padding: 12px 20px;
            border: 1px solid #dee2e6;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.3s;
        }
        .tab-button.active {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            transform: translateY(-1px);
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .timeline-event {
            background: #f8f9fa;
            border-left: 4px solid #007bff;
            padding: 15px;
            margin: 10px 0;
            border-radius: 0 6px 6px 0;
        }
        .upload-progress {
            width: 100%;
            height: 8px;
            background-color: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }
        .upload-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #007bff, #0056b3);
            transition: width 0.3s;
            width: 0%;
        }
        .json-display {
            background: #263238;
            color: #00ff41;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #37474f;
        }
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-online { background-color: #28a745; }
        .status-offline { background-color: #dc3545; }
        .status-warning { background-color: #ffc107; }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
        }
        h2 {
            color: #34495e;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        h3 {
            color: #495057;
            margin-top: 25px;
        }
    </style>
</head>
<body>
    <h1>🏥 MediTwin Complete API Test Suite</h1>
    
    <!-- System Status -->
    <div class="container">
        <h2>🔧 System Status</h2>
        <p>
            <span class="status-indicator status-offline" id="backendStatus"></span>
            <strong>Backend:</strong> <span id="backendStatusText">Checking...</span>
        </p>
        <p>
            <span class="status-indicator status-offline" id="authStatus"></span>
            <strong>Authentication:</strong> <span id="authStatusText">Not logged in</span>
        </p>
        <button onclick="checkSystemStatus()">Check System Status</button>
    </div>
    
    <!-- Tab Navigation -->
    <div class="tab-buttons">
        <button class="tab-button active" onclick="showTab('auth', this)">🔐 Authentication</button>
        <button class="tab-button" onclick="showTab('chat', this)">💬 Chat & RAG</button>
        <button class="tab-button" onclick="showTab('upload', this)">📁 Upload & Documents</button>
        <button class="tab-button" onclick="showTab('timeline', this)">📅 Timeline & Events</button>
        <button class="tab-button" onclick="showTab('anatomy', this)">🫀 Anatomy & Body</button>
        <button class="tab-button" onclick="showTab('profile', this)">👤 Profile & Settings</button>
    </div>

    <!-- Authentication Tab -->
    <div id="auth" class="tab-content active">
        <div class="container">
            <h2>🔐 Authentication & User Management</h2>
            
            <h3>🆕 Sign Up</h3>
            <div class="form-group">
                <label for="signupEmail">Email:</label>
                <input type="email" id="signupEmail" value="doctor@meditwin.com">
            </div>
            <div class="form-group">
                <label for="signupUsername">Username:</label>
                <input type="text" id="signupUsername" value="drsmith">
            </div>
            <div class="form-group">
                <label for="signupPassword">Password:</label>
                <input type="password" id="signupPassword" value="SecurePass123!">
            </div>
            <div class="form-group">
                <label for="signupFullName">Full Name:</label>
                <input type="text" id="signupFullName" value="Dr. John Smith">
            </div>
            <button onclick="signup()">🆕 Sign Up</button>
            
            <hr style="margin: 30px 0;">
            
            <h3>🔑 Log In</h3>
            <div class="form-group">
                <label for="loginEmail">Email:</label>
                <input type="email" id="loginEmail" value="doctor@meditwin.com">
            </div>
            <div class="form-group">
                <label for="loginPassword">Password:</label>
                <input type="password" id="loginPassword" value="SecurePass123!">
            </div>
            <button onclick="login()">🔑 Log In</button>
            
            <hr style="margin: 30px 0;">
            
            <h3>🔄 Token Management</h3>
            <button onclick="refreshToken()">🔄 Refresh Token</button>
            <button onclick="logout()">🚪 Logout</button>
            <button onclick="clearTokens()">🗑️ Clear Local Data</button>
            
            <div id="authResult"></div>
            
            <div id="tokensDisplay" class="tokens-display hidden">
                <h4>🎫 Stored Tokens:</h4>
                <div id="tokensContent"></div>
            </div>
        </div>
    </div>

    <!-- Chat & RAG Tab -->
    <div id="chat" class="tab-content">
        <div class="container">
            <h2>💬 Chat & RAG Testing</h2>
            <p class="info">🤖 Test the multi-agent medical consultation system with OpenAI GPT-4o-mini integration.</p>
            
            <h3>💬 Send Chat Message</h3>
            <div class="form-group">
                <label for="chatMessage">Medical Query:</label>
                <textarea id="chatMessage" rows="4" placeholder="Describe your symptoms or ask a medical question...">I've been experiencing chest pain and shortness of breath during exercise. Could this be related to my heart? I'm 45 years old, male, and have a family history of heart disease.</textarea>
            </div>
            <div class="form-group">
                <label for="sessionId">Session ID (optional):</label>
                <input type="text" id="sessionId" placeholder="Leave empty for auto-generation">
            </div>
            <div class="form-group">
                <label for="specialist">Preferred Specialist:</label>
                <select id="specialist">
                    <option value="">Auto-route (Orchestrator decides)</option>
                    <option value="cardiologist">🫀 Cardiologist</option>
                    <option value="neurologist">🧠 Neurologist</option>
                    <option value="orthopedist">🦴 Orthopedist</option>
                    <option value="general_physician">🩺 General Physician</option>
                </select>
            </div>
            <button onclick="sendChatMessage()">💬 Send Message</button>
            <button onclick="streamChatMessage()">📡 Stream Response</button>
            <button onclick="getChatHistory()">📋 Get Chat History</button>
            <button onclick="clearChatHistory()">🗑️ Clear History</button>
            
            <div id="chatResult"></div>
            
            <h3>🔍 Test Medical Queries</h3>
            <button onclick="testQuery('What are the symptoms of diabetes?')">🍬 Diabetes Query</button>
            <button onclick="testQuery('I have a headache and fever, what could it be?')">🤒 Symptom Analysis</button>
            <button onclick="testQuery('Explain my blood pressure reading of 140/90')">🩸 Blood Pressure</button>
            <button onclick="testQuery('What exercises are good for lower back pain?')">🏋️ Exercise Advice</button>
        </div>
    </div>

    <!-- Upload & Documents Tab -->
    <div id="upload" class="tab-content">
        <div class="container">
            <h2>📁 Document Upload & Processing</h2>
            <p class="info">📄 Upload medical documents, test OCR processing, and document analysis.</p>
            
            <h3>📤 Upload Document</h3>
            <div class="form-group">
                <label for="documentFile">Select Medical Document:</label>
                <input type="file" id="documentFile" accept=".pdf,.png,.jpg,.jpeg,.tiff,.bmp">
            </div>
            <div class="form-group">
                <label for="documentDescription">Description (optional):</label>
                <textarea id="documentDescription" rows="2" placeholder="Brief description of the document..."></textarea>
            </div>
            <div class="form-group">
                <label for="documentType">Document Type:</label>
                <select id="documentType">
                    <option value="lab_report">🧪 Lab Report</option>
                    <option value="prescription">💊 Prescription</option>
                    <option value="medical_history">📋 Medical History</option>
                    <option value="x_ray">🩻 X-Ray</option>
                    <option value="mri_scan">🔬 MRI Scan</option>
                    <option value="ct_scan">📡 CT Scan</option>
                    <option value="other">📄 Other</option>
                </select>
            </div>
            <button onclick="uploadDocument()">📤 Upload Document</button>
            <button onclick="createSampleDocument()">📝 Create Sample PDF</button>
            
            <div class="upload-progress hidden" id="uploadProgress">
                <div class="upload-progress-bar" id="uploadProgressBar"></div>
            </div>
            
            <div id="uploadResult"></div>
            
            <h3>📊 Upload History</h3>
            <button onclick="getUploadHistory()">📋 Get Upload History</button>
            <button onclick="checkDocumentStatus()">🔍 Check Document Status</button>
            
            <div id="uploadHistoryResult"></div>
        </div>
    </div>

    <!-- Timeline & Events Tab -->
    <div id="timeline" class="tab-content">
        <div class="container">
            <h2>📅 Medical Timeline & Events</h2>
            <p class="info">⏰ Manage your medical timeline, events, and health history.</p>
            
            <h3>📅 View Timeline</h3>
            <div class="form-group">
                <label for="timelineStartDate">Start Date:</label>
                <input type="date" id="timelineStartDate">
            </div>
            <div class="form-group">
                <label for="timelineEndDate">End Date:</label>
                <input type="date" id="timelineEndDate">
            </div>
            <div class="form-group">
                <label for="eventTypes">Event Types:</label>
                <select id="eventTypes" multiple>
                    <option value="medical">🏥 Medical</option>
                    <option value="symptom">🤒 Symptom</option>
                    <option value="treatment">💊 Treatment</option>
                    <option value="medication">💉 Medication</option>
                    <option value="lab_test">🧪 Lab Test</option>
                    <option value="lifestyle">🏃 Lifestyle</option>
                    <option value="injury">🩹 Injury</option>
                </select>
            </div>
            <button onclick="getTimeline()">📅 Get Timeline</button>
            <button onclick="getTimelineSummary()">📊 Get Summary</button>
            <button onclick="createSampleEvents()">📝 Create Sample Events</button>
            
            <h3>➕ Add New Event</h3>
            <div class="form-group">
                <label for="eventTitle">Event Title:</label>
                <input type="text" id="eventTitle" placeholder="e.g., Annual Physical Exam">
            </div>
            <div class="form-group">
                <label for="eventDescription">Description:</label>
                <textarea id="eventDescription" rows="3" placeholder="Detailed description of the event..."></textarea>
            </div>
            <div class="form-group">
                <label for="eventType">Event Type:</label>
                <select id="eventType">
                    <option value="medical">🏥 Medical Event</option>
                    <option value="symptom">🤒 Symptom</option>
                    <option value="treatment">💊 Treatment</option>
                    <option value="medication">💉 Medication</option>
                    <option value="lab_test">🧪 Lab Test</option>
                    <option value="lifestyle">🏃 Lifestyle</option>
                    <option value="injury">🩹 Injury</option>
                </select>
            </div>
            <div class="form-group">
                <label for="eventSeverity">Severity:</label>
                <select id="eventSeverity">
                    <option value="low">🟢 Low</option>
                    <option value="medium">🟡 Medium</option>
                    <option value="high">🟠 High</option>
                    <option value="critical">🔴 Critical</option>
                </select>
            </div>
            <div class="form-group">
                <label for="eventTimestamp">Date & Time:</label>
                <input type="datetime-local" id="eventTimestamp">
            </div>
            <button onclick="createEvent()">➕ Add Event</button>
            
            <div id="timelineResult"></div>
        </div>
    </div>

    <!-- Anatomy & Body Tab -->
    <div id="anatomy" class="tab-content">
        <div class="container">
            <h2>🫀 Anatomy & Body Systems</h2>
            <p class="info">🔍 Explore anatomical information and body system data.</p>
            
            <h3>🔍 Body Systems Overview</h3>
            <button onclick="getAnatomyOverview()">🫀 Full Body Overview</button>
            <button onclick="getBodySystems()">🏗️ List Body Systems</button>
            
            <h3>🎯 Specific Body Part Analysis</h3>
            <div class="form-group">
                <label for="bodyPart">Body Part:</label>
                <select id="bodyPart">
                    <option value="Heart">🫀 Heart</option>
                    <option value="Brain">🧠 Brain</option>
                    <option value="Lungs">🫁 Lungs</option>
                    <option value="Liver">🫄 Liver</option>
                    <option value="Kidneys">🫘 Kidneys</option>
                    <option value="Right Shoulder">🤲 Right Shoulder</option>
                    <option value="Left Knee">🦵 Left Knee</option>
                    <option value="Spine">🦴 Spine</option>
                    <option value="Stomach">🫃 Stomach</option>
                    <option value="Eyes">👁️ Eyes</option>
                </select>
            </div>
            <button onclick="getBodyPartTimeline()">📅 Get Body Part Timeline</button>
            <button onclick="getBodyPartInfo()">ℹ️ Get Body Part Info</button>
            
            <h3>🏗️ Test Body System Queries</h3>
            <button onclick="testAnatomyQuery('cardiovascular')">🫀 Cardiovascular System</button>
            <button onclick="testAnatomyQuery('nervous')">🧠 Nervous System</button>
            <button onclick="testAnatomyQuery('respiratory')">🫁 Respiratory System</button>
            <button onclick="testAnatomyQuery('musculoskeletal')">🦴 Musculoskeletal System</button>
            
            <div id="anatomyResult"></div>
        </div>
    </div>

    <!-- Profile & Settings Tab -->
    <div id="profile" class="tab-content">
        <div class="container">
            <h2>👤 User Profile & Settings</h2>
            <p class="info">👤 Manage your profile, verify tokens, and check system information.</p>
            
            <h3>👤 Profile Information</h3>
            <button onclick="getUserProfile()">👤 Get My Profile</button>
            <button onclick="verifyToken()">🔐 Verify Token</button>
            <button onclick="updateProfile()">✏️ Update Profile</button>
            
            <h3>⚙️ System Information</h3>
            <button onclick="getSystemHealth()">🏥 System Health</button>
            <button onclick="getApiDocumentation()">📚 API Documentation</button>
            
            <h3>🧪 Advanced Testing</h3>
            <button onclick="runFullSystemTest()">🧪 Run Full System Test</button>
            <button onclick="generateTestData()">📊 Generate Test Data</button>
            <button onclick="exportUserData()">📤 Export User Data</button>
            
            <div id="profileResult"></div>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE_URL = 'http://localhost:8000';
        
        let currentSessionId = null;
        let systemStatus = {
            backend: false,
            auth: false
        };
        
        // Token storage functions
        function getAccessToken() {
            return localStorage.getItem('access_token');
        }
        
        function getRefreshToken() {
            return localStorage.getItem('refresh_token');
        }
        
        function setTokens(accessToken, refreshToken, userId) {
            localStorage.setItem('access_token', accessToken);
            localStorage.setItem('refresh_token', refreshToken);
            if (userId) localStorage.setItem('user_id', userId);
            updateTokensDisplay();
            updateAuthStatus(true);
        }
        
        function clearTokens() {
            localStorage.removeItem('access_token');
            localStorage.removeItem('refresh_token');
            localStorage.removeItem('user_id');
            updateTokensDisplay();
            updateAuthStatus(false);
            showMessage('authResult', '🗑️ All local data cleared', 'info');
        }
        
        function updateTokensDisplay() {
            const accessToken = getAccessToken();
            const refreshToken = getRefreshToken();
            const tokensDisplay = document.getElementById('tokensDisplay');
            const tokensContent = document.getElementById('tokensContent');
            
            if (accessToken || refreshToken) {
                tokensDisplay.classList.remove('hidden');
                tokensContent.innerHTML = `
                    <p><strong>🎫 Access Token:</strong> ${accessToken ? `${accessToken.substring(0, 30)}...` : 'None'}</p>
                    <p><strong>🔄 Refresh Token:</strong> ${refreshToken ? `${refreshToken.substring(0, 30)}...` : 'None'}</p>
                    <p><strong>👤 User ID:</strong> ${localStorage.getItem('user_id') || 'Unknown'}</p>
                `;
            } else {
                tokensDisplay.classList.add('hidden');
            }
        }
        
        // Utility functions
        function showMessage(elementId, message, type, isHtml = false) {
            const element = document.getElementById(elementId);
            const messageContent = isHtml ? message : escapeHtml(message);
            element.innerHTML = `<div class="${type}">${messageContent}</div>`;
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function showTab(tabName, buttonElement) {
            // Hide all tab contents
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(content => content.classList.remove('active'));
            
            // Remove active class from all tab buttons
            const tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach(button => button.classList.remove('active'));
            
            // Show selected tab and mark button as active
            document.getElementById(tabName).classList.add('active');
            buttonElement.classList.add('active');
        }
        
        function updateAuthStatus(isAuthenticated) {
            const statusEl = document.getElementById('authStatus');
            const textEl = document.getElementById('authStatusText');
            
            if (isAuthenticated) {
                statusEl.className = 'status-indicator status-online';
                textEl.textContent = 'Authenticated';
                systemStatus.auth = true;
            } else {
                statusEl.className = 'status-indicator status-offline';
                textEl.textContent = 'Not authenticated';
                systemStatus.auth = false;
            }
        }
        
        function updateBackendStatus(isOnline) {
            const statusEl = document.getElementById('backendStatus');
            const textEl = document.getElementById('backendStatusText');
            
            if (isOnline) {
                statusEl.className = 'status-indicator status-online';
                textEl.textContent = 'Online';
                systemStatus.backend = true;
            } else {
                statusEl.className = 'status-indicator status-offline';
                textEl.textContent = 'Offline';
                systemStatus.backend = false;
            }
        }
        
        // API call wrapper with JWT support
        async function apiCall(endpoint, options = {}) {
            const url = `${API_BASE_URL}${endpoint}`;
            const accessToken = getAccessToken();
            
            const defaultOptions = {
                headers: {
                    'Content-Type': 'application/json',
                    ...(accessToken && { 'Authorization': `Bearer ${accessToken}` })
                }
            };
            
            const mergedOptions = {
                ...defaultOptions,
                ...options,
                headers: {
                    ...defaultOptions.headers,
                    ...options.headers
                }
            };
            
            try {
                const response = await fetch(url, mergedOptions);
                
                if (response.status === 401 && accessToken) {
                    // Try to refresh token
                    const refreshed = await refreshTokenSilently();
                    if (refreshed) {
                        // Retry the request with new token
                        mergedOptions.headers['Authorization'] = `Bearer ${getAccessToken()}`;
                        const retryResponse = await fetch(url, mergedOptions);
                        const retryData = await retryResponse.json();
                        
                        if (!retryResponse.ok) {
                            throw new Error(retryData.detail || `HTTP ${retryResponse.status}: ${retryResponse.statusText}`);
                        }
                        
                        return retryData;
                    }
                }
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.detail || `HTTP ${response.status}: ${response.statusText}`);
                }
                
                return data;
            } catch (error) {
                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    updateBackendStatus(false);
                    throw new Error('Backend server is not responding. Please check if the server is running.');
                }
                throw error;
            }
        }
        
        // Authentication functions
        async function signup() {
            try {
                const email = document.getElementById('signupEmail').value;
                const username = document.getElementById('signupUsername').value;
                const password = document.getElementById('signupPassword').value;
                const fullName = document.getElementById('signupFullName').value;
                
                const response = await apiCall('/auth/signup', {
                    method: 'POST',
                    body: JSON.stringify({
                        email,
                        username,
                        password,
                        full_name: fullName || undefined
                    })
                });
                
                setTokens(response.access_token, response.refresh_token, response.user_id);
                showMessage('authResult', `🎉 Signup successful! Welcome ${username}! User ID: ${response.user_id}`, 'success');
                
            } catch (error) {
                showMessage('authResult', `❌ Signup failed: ${error.message}`, 'error');
            }
        }
        
        async function login() {
            try {
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;
                
                const response = await apiCall('/auth/login', {
                    method: 'POST',
                    body: JSON.stringify({ email, password })
                });
                
                setTokens(response.access_token, response.refresh_token, response.user_id);
                showMessage('authResult', `🎉 Login successful! User ID: ${response.user_id}`, 'success');
                
            } catch (error) {
                showMessage('authResult', `❌ Login failed: ${error.message}`, 'error');
            }
        }
        
        async function refreshToken() {
            try {
                const refresh_token = getRefreshToken();
                if (!refresh_token) {
                    throw new Error('No refresh token available');
                }
                
                const response = await apiCall('/auth/refresh', {
                    method: 'POST',
                    body: JSON.stringify({ refresh_token })
                });
                
                setTokens(response.access_token, response.refresh_token, response.user_id);
                showMessage('authResult', '🔄 Tokens refreshed successfully!', 'success');
                
            } catch (error) {
                showMessage('authResult', `❌ Token refresh failed: ${error.message}`, 'error');
            }
        }
        
        async function refreshTokenSilently() {
            try {
                const refresh_token = getRefreshToken();
                if (!refresh_token) return false;
                
                const response = await apiCall('/auth/refresh', {
                    method: 'POST',
                    body: JSON.stringify({ refresh_token })
                });
                
                setTokens(response.access_token, response.refresh_token, response.user_id);
                return true;
            } catch (error) {
                clearTokens();
                return false;
            }
        }
        
        async function logout() {
            try {
                const refresh_token = getRefreshToken();
                if (refresh_token) {
                    await apiCall('/auth/logout', {
                        method: 'POST',
                        body: JSON.stringify({ refresh_token })
                    });
                }
                
                clearTokens();
                showMessage('authResult', '🚪 Logged out successfully!', 'success');
                
            } catch (error) {
                clearTokens();
                showMessage('authResult', `🚪 Logged out (${error.message})`, 'info');
            }
        }
        
        // Protected API functions
        async function sendChatMessage() {
            try {
                const message = document.getElementById('chatMessage').value;
                const sessionId = document.getElementById('sessionId').value;
                
                if (!message.trim()) {
                    throw new Error('Message cannot be empty');
                }
                
                const requestBody = {
                    message: message.trim()
                };
                
                if (sessionId.trim()) {
                    requestBody.session_id = sessionId.trim();
                }
                
                const response = await apiCall('/chat/message', {
                    method: 'POST',
                    body: JSON.stringify(requestBody)
                });
                
                showMessage('chatResult', 
                    `<strong>Response:</strong> ${response.response}<br>
                     <strong>Session ID:</strong> ${response.session_id}`, 
                    'success');
                
                // Update session ID field if it was auto-generated
                if (!sessionId.trim()) {
                    document.getElementById('sessionId').value = response.session_id;
                }
                
            } catch (error) {
                showMessage('chatResult', `Chat failed: ${error.message}`, 'error');
            }
        }
        
        async function getChatHistory() {
            try {
                const sessionId = document.getElementById('sessionId').value;
                if (!sessionId.trim()) {
                    throw new Error('Session ID is required for chat history');
                }
                
                const response = await apiCall(`/chat/history/${sessionId.trim()}`);
                
                const messagesHtml = response.messages.map(msg => 
                    `<p><strong>${msg.role}:</strong> ${msg.content}</p>`
                ).join('');
                
                showMessage('chatResult', 
                    `<strong>Chat History (${response.total_messages} messages):</strong><br>${messagesHtml}`, 
                    'info');
                
            } catch (error) {
                showMessage('chatResult', `Failed to get chat history: ${error.message}`, 'error');
            }
        }
        
        async function getUserProfile() {
            try {
                const response = await apiCall('/auth/me');
                
                showMessage('profileResult', 
                    `<strong>User Profile:</strong><br>
                     User ID: ${response.user_id}<br>
                     Email: ${response.email}<br>
                     Username: ${response.username}<br>
                     Full Name: ${response.full_name || 'Not provided'}<br>
                     Active: ${response.is_active}<br>
                     Created: ${new Date(response.created_at).toLocaleString()}<br>
                     Roles: ${response.roles.join(', ') || 'None'}`, 
                    'success');
                
            } catch (error) {
                showMessage('profileResult', `Failed to get profile: ${error.message}`, 'error');
            }
        }
        
        async function verifyToken() {
            try {
                const response = await apiCall('/auth/verify', { method: 'POST' });
                
                showMessage('profileResult', 
                    `<strong>Token Verification:</strong><br>
                     Valid: ${response.valid}<br>
                     User ID: ${response.user_id}<br>
                     Email: ${response.email || 'Not provided'}<br>
                     Username: ${response.username || 'Not provided'}`, 
                    'success');
                
            } catch (error) {
                showMessage('profileResult', `Token verification failed: ${error.message}`, 'error');
            }
        }
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            updateTokensDisplay();
        });
    </script>
</body>
</html>
